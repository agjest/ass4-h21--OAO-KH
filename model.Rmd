---
title: "model"
author:
- Kevin Ha - 571821
- Ola Andre Olofsson - 170745
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
library(tidyverse)
library(lubridate)
library(modelr)
library(broom)
library(lmtest)
library(sandwich)
library(viridis)
})
knitr::opts_chunk$set(echo=FALSE, include = FALSE)
```

# Modeller

## Leser inn data

```{r reading file}
pm2 <- read_csv("data/pm2.csv", show_col_types = FALSE, locale = locale(encoding = "ISO-8859-1"))
```

Vi fekk etter denne read_csv funksjonen ein ekstra rad som ikke skal vere der. Vi fjerner denne.

```{r}
names(pm2)[[1]] <- "Fjern"
```

-

```{r}
pm2 <- pm2 %>% 
  select(-Fjern)
```

Vi har nå det vi trenger for å gå videre.

Vi er interessert i fylkesnummeret (de to første siffrene i kommunenummeret). Vi bruker mutate() for å gjøre om kolonner for kommunenummer om til typen "factor"

```{r konvertering til faktor}
pm2 <- pm2 %>% 
  mutate(
    fnr = str_sub(knr, 1,2),
    aar_f = str_sub(aar))
```

-

```{r parserer faktorer}
pm2 %>% 
  mutate(
    fnr = parse_factor(fnr, levels = fnr),
    aar_f = parse_factor(aar_f, levels = aar_f))
```

-

```{r skalerer Trade_pc}
pm2 <- pm2 %>%
  mutate(Trade_pc_100K = Trade_pc/100000) 
```

-

Sjekker korleis modellen ser ut

```{r visuell kontroll}
head(pm2, n = 4)
```

## Modell

```{r mod1}
mod1 <- 'pm2 ~ aar_f + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K'
```

### Generer et lm objekt (lm1) utfra mod1 og datasettet pm2.

```{r lm1}
lm1 <- lm(mod1, data = pm2)
```

-

```{r Summary_lm1}
summary(lm1)
```


### Legger residualene fra den lineære modellen til datasettet pm2.

```{r legger til residualer}
pm2 %>%
  add_residuals(lm1)
```

-

```{r head_pm2}
head(pm2, n=4)
```

### Forklaring av koeffisienter

Einase eg kan sjå ved koeffisientane er at nesten alle er signifikante på 0.5% nivå og dei fleste har solide t-verdiar. I tillegg til dette så er $R^2$ på 0.8346, som vil sei at modellen vår med desse variablane forteller ca 83.46%.

### Breuch-Pagen test for heteroskedastisitet

```{r bptest_lm1}
bptest(lm1)
```

Vi ser at p-verdien er lang under 0.5%, og ser dermed grunnlag for heteroskedastisitet.

Nullhypotesen forkastes dersom p-verdien er lavere enn 5%. I dette tilfellet vurderes det dette at nullhypotesen forkastes (ikke) ettersom p-verdien er langt under 0.5%

### Koeffisient-test og VcovHC

```{r Coeftest}
coeftest(lm1)
```

-

```{r VcovHC}
vcovHC(lm1)
```

### Lager ny aar-variabel

```{r Ny_aar}
pm2 <- pm2 %>%
  mutate(aar_d = make_date(aar))
```

### Residualer

```{r Residualer_lm1}
pm2 <- pm2 %>%
  add_residuals(lm1)
```

### Fylker

```{r Mutate_Substr}
pm2 <- pm2 %>%
  mutate(fylke = substr(knr, start = 1, stop = 2))
```

-

### GGplot Av Fylker

```{r GGPlot}
pm2 %>% 
  filter(fylke %in% c("01", "02", "03", "11", "12")) %>% 
  unnest(c(fylke)) %>% 
  group_by(fylke, aar_d) %>% 
  summarise(mean_fylke = mean(resid)) %>% 
  ggplot(mapping = aes(x= aar_d, y= mean_fylke, colour = fylke)) +
  geom_line(lwd=1) +
  geom_hline(yintercept = 0, colour = "white") +
  theme(legend.position = "bottom")
```

## Dummy

Lager ein ny modell

```{r Mod2}
mod2 <- 'pm2 ~ aar_f*fnr + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K'
```

-

```{r lm2}
lm2 <- lm(mod2, data = pm2)
```

-

```{r Summary_lm2}
summary(lm2)
```

-

```{r Residualer_lm2}
pm2 <- pm2 %>% 
  mutate(res_m2 = resid(lm2))
```

-

```{r Plot}
pm2 %>% 
  filter(fnr %in% c("01", "02", "04", "11", "12")) %>%
ggplot(mapping = aes(x = aar_d, y = res_m2)) +
geom_line(aes(group = knavn)) +
scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
geom_hline(yintercept = 0) +
theme(legend.position = 'bottom') +
  facet_wrap(~fylke)
```

### Diskusjon, Modell 2

Da det er stor variasjon på alle grafene våres, så ser det ut til at modell 2 ikke traff så altfor bra.

Med tanke på at vi hadde 16 variabler i datasettet før vi begynte å filtere og lage modeller, der modellene ikke inneholder halvparten av variablene våres en gang, i tillegg til at vi kan ha oversett noen andre variabler, så kan vi si med høy sannsynelighet at modellen mangler viktige forklarende variabler, ja.

### Filterer med Hensyn på Fylke 11

Her bruker vi informasjonen gitt i oppgaven

```{r Filter_Fylke_11}
pm2 %>%
  filter(fnr %in% c("11")) %>%
  ggplot(mapping = aes(x = aar_d, y = res_m2)) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  geom_line(aes(group = knavn, colour = knavn, size = knavn)) +
  scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'bottom')
```

### Gjentar det samme plottet ovenfor, men med hensyn på utvalgte kommuner

```{r Plot_Pm2_Kommune}
pm2 %>%
  filter(knr %in% c("1119", "1120", "1127", "1121", "1130", "1135", "1106", "1149")) %>% 
  ggplot(mapping = aes(x = aar_d, y = res_m2)) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  geom_line(aes(group = knavn, colour = knavn, size = knavn)) +
  scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'bottom')
```

#### Kommentarer til grafen

Det denne grafen forteller oss er at hus/leiligheter som er nærme Stavanger området er overvurdert prismessig, mens hus/leiligheter som er nærme Haugesunds regionen er undervurdert

## Modell for kvart år

Lager en aar_d variabel som date objekt

```{r Pm2_Mutate_Aar}
pm2 <- pm2 %>% 
  mutate(
    aar_d = date(paste0(aar, "-01-01"))
  )
```


```{r Lager_Pm2_n}
pm2_n <- pm2 %>%
  select(pm2, fnr, knr, aar_d, aar, aar_f, Menn_ya_p, Kvinner_ya_p, Totalt_ya_p, inc_k1, inc_k5, mf_uni_k, mf_uni_l, Trade_pc_100K) %>%
  group_by(aar_d) %>%
  nest()
```


```{r Pm2_n}
pm2_n
```


```{r Pm2_n_Data}
pm2_n$data[[1]] %>%
head(n = 5)
```

-

Sjekker dimmensjonen vår

```{r Dim_Pm2}
dim(pm2_n)
```

-

```{r Kom_Model}
kom_model <- function(a_df) {
  lm(pm2 ~ fnr + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K, data = a_df)
}
```

-

```{r Pm2_Mutate}
pm2_n <- pm2_n %>% 
  mutate(model = map(data, .f = kom_model))
```

-

```{r Summary}
# summary 2008
pm2_n$model[[1]] %>%
  summary()
```



```{r Pm2_n}
pm2_n %>%
  filter(aar_d == "2008-01-01") %>% 
  .$model %>%
  map_df(glance)
```

-

```{r Mod_Sum_Unnest}
mod_sum <- pm2_n %>% 
  mutate(mod_summary = map(.x = model, .f = glance)) %>% 
  unnest(mod_summary) %>% 
  print()
```

-
## Coef_Df & Tibble variabler
Lager ny variabel *coef_df* med *mod_sum*

```{r Lager_Coef_df}
coef_df <- mod_sum$model %>% 
  map_df(1) %>% 
  tibble()
```

-

```{r Lager_Aar}
coef_df <- coef_df %>%
  mutate(
    aar = ymd(paste(2008:2017, "-01-01", sep = ""))
  ) %>%
  select(aar, everything())
```

Bruker pivot_longer på *coef_df* for å lage *coef_df_long*

```{r Lager_Coef_df_Long}
coef_df_long <- coef_df %>%
  pivot_longer(
    cols = `(Intercept)`:`Trade_pc_100K`,
    names_to = "variables",
    values_to = "coef")
```

Vi bruker så *coef_df_long* videre for å lage ein ggplot av fylke-faktorvariablenes koeffisienter.

```{r Plot}
coef_df_long %>%
  select(aar, variables, coef) %>%
  filter(
    variables %in% c("fnr02", "fnr03", "fnr04", "fnr10", "fnr11", "fnr12", "fnr14")
  ) %>%
  ggplot(mapping = aes(x = aar, y = coef, colour = variables)) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  geom_line(aes(group = variables), lwd = 1) +
  theme(legend.position = 'bottom')
```

### Kommentarer til modellen

Vi ser ut ifra plottet at fnr03 har vært sterkt stigende over tid. Dette betyr at prisane i dette fylket(?) har auka kontinuerlig over fleire år.

Vi ser videre at fnr02 har vært så og sei stabil over flere år. Dette betyr at dette fylket(?) har hatt ein ganske stabil utvikling

Resten av fnr variablene har vært synkende over tid. Dette betyr at verdien/prisane i disse fylkene(?) har hatt ein negativ utvikling over tid.

#### 2014

I 2014 så hadde vi ein "oljekrise" der prisen på olje hadde et kraftig fall, og flere ble perimeterte og/eller mistet jobben. Områder som låg var avhengig av jobber relatert til oljenæringa, f.eks. Stavanger mistet da en del av dets attraktivitet.

## Tilsvarende Plot, Nye Variabler

```{r Plot}
coef_df_long %>%
select(aar, variables, coef) %>%
filter(
variables %in% c("Totalt_ya_p", "inc_k1", "inc_k5", "mf_uni_k", "mf_uni_l", "Trade_pc_100K")
) %>%
ggplot(mapping = aes(x = aar, y = coef, colour = variables)) +
scale_color_viridis(discrete = TRUE, option = "D") +
geom_line(aes(group = variables), lwd = 1) +
theme(legend.position = 'bottom')
```

### Diskusjon

Md untak av *Trade_pc_100K* og *inc_k1* variablane, så ser det ut til at koeffisientane er ganske stabile over tid. Det er forsåvidt ikkje stor ustabilitet for *inc_k1* heller, men den er litt meir ustabil enn dei andre 4, og den har ein konstant nedgåande trend. *Trade_pc_100K* koeffisienten derimot er ikkje stabil på sikt.
