---
title: "model"
author:
- Kevin Ha - 571821
- Ola Andre Olofsson - 170745
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
library(tidyverse)
library(lubridate)
library(modelr)
library(broom)
library(lmtest)
library(sandwich)
library(viridis)
})
knitr::opts_chunk$set(echo=FALSE, include = FALSE)
```

# Modeller

## Leser inn data

```{r reading file}
pm2 <- read_csv("data/pm2.csv", show_col_types = FALSE, locale = locale(encoding = "ISO-8859-1"))
```

Vi fekk etter denne read_csv funksjonen ein ekstra rad som ikke skal vere der. Vi fjerner denne.

```{r}
names(pm2)[[1]] <- "Fjern"
```

-

```{r}
pm2 <- pm2 %>% 
  select(-Fjern)
```

Vi har nå det vi trenger for å gå videre.

Vi er interessert i fylkesnummeret (de to første siffrene i kommunenummeret). Vi bruker mutate() for å gjøre om kolonner for kommunenummer om til typen "factor"

```{r konvertering til faktor}
pm2 <- pm2 %>% 
  mutate(
    fnr = str_sub(knr, 1,2),
    aar_f = str_sub(aar))
```

-

```{r parserer faktorer}
pm2 %>% 
  mutate(
    fnr = parse_factor(fnr, levels = fnr),
    aar_f = parse_factor(aar_f, levels = aar_f))
```

-

```{r skalerer Trade_pc}
pm2 <- pm2 %>%
  mutate(Trade_pc_100K = Trade_pc/100000) 
```

-

```{r visuell kontroll}
head(pm2, n = 4)
```

## Modell

```{r mod1}
mod1 <- 'pm2 ~ aar_f + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K'
```

### i. generer et lm objekt (lm1) utfra mod1 og datasettet pm2.

```{r lm1}
lm1 <- lm(mod1, data = pm2)
```

-

```{r Summary_lm1}
summary(lm1)
```


### ii. Legg residualene fra den lineære modellen til datasettet pm2.

```{r legger til residualer}
pm2 %>%
  add_residuals(lm1)
```

-

```{r head_pm2}
head(pm2, n=4)
```

### Forklaring av koeffisienter - ???

???

### Breuch-Pagen test for heteroskedastisitet

```{r bptest_lm1}
bptest(lm1)
```

Vi ser at p-verdien er X.XXX, og ser dermed grunnlag for heteroskedastisitet.
Nullhypotesen forkastes dersom p-verdien er lavere enn 5%. I dette tilfellet vurderes det dithen at nullhypotesen forkastes (ikke) ettersom p-verdien er X.XXX

### Koeffisient-test og VcovHC

```{r Coeftest}
coeftest(lm1)
```

-

```{r VcovHC}
vcovHC(lm1)
```

### Lager ny aar-variabel

```{r Ny_aar}
pm2 <- pm2 %>%
  mutate(aar_d = make_date(aar))
```

### Residualer

```{r Residualer_lm1}
pm2 <- pm2 %>%
  add_residuals(lm1)
```

### Fylker

```{r Mutate_Substr}
pm2 <- pm2 %>%
  mutate(fylke = substr(knr, start = 1, stop = 2))
```

-

```{r Filter}
pm2 <- pm2 %>% 
  filter(fylke %in% c("01", "02", "03", "11", "12"))
```

### GGplot Av Fylker

```{r GGPlot}
pm2 %>% 
  unnest(c(fylke)) %>% 
  group_by(fylke, aar_d) %>% 
  summarise(mean_fylke = mean(resid)) %>% 
  ggplot(mapping = aes(x= aar_d, y= mean_fylke, colour = fylke)) +
  geom_line(lwd=1) +
  geom_hline(yintercept = 0, colour = "white") +
  theme(legend.position = "bottom")
```

# Dummy

```{r Mod2}
mod2 <- 'pm2 ~ aar_f*fnr + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K'
```

-

```{r lm2}
lm2 <- lm(mod2, data = pm2)
```

-

```{r Summary_lm2}
summary(lm2)
```

-

```{r Residualer_lm2}
pm2 <- pm2 %>% 
  mutate(res_m2 = resid(lm2))
```

-

```{r Plot}
pm2 %>% 
  filter(fnr %in% c("01", "02", "04", "11", "12")) %>%
ggplot(mapping = aes(x = aar_d, y = res_m2)) +
geom_line(aes(group = knavn)) +
scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
geom_hline(yintercept = 0) +
theme(legend.position = 'bottom') +
  facet_wrap(~fylke)
```

### Diskusjon, Modell 2

Da det er stor variasjon på alle grafene våres, så ser det ut til at modell 2 ikke traff så altfor bra.

Med tanke på at vi hadde 16 variabler i datasettet før vi begynte å filtere og lage modeller, der modellene ikke inneholder halvparten av variablene våres en gang, i tillegg til at vi kan ha oversett noen andre variabler, så kan vi si med høy sannsynelighet at modellen mangler viktige forklarende variabler, ja.

#### Filterer med Hensyn på Fylke 11

Her bruker vi informasjonen gitt i oppgaven

```{r Filter_Fylke_11}
pm2 %>%
  filter(fnr %in% c("11")) %>%
  ggplot(mapping = aes(x = aar_d, y = res_m2)) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  geom_line(aes(group = knavn, colour = knavn, size = knavn)) +
  scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'bottom')
```

### Gjentar det samme plottet ovenfor, men med hensyn på utvalgte kommuner

```{r}
pm2 %>%
  filter(knr %in% c("1119", "1120", "1127", "1121", "1130", "1135", "1106", "1149")) %>%
  ggplot(mapping = aes(x = aar_d, y = res_m2)) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  geom_line(aes(group = knavn, colour = knavn, size = knavn)) +
  scale_size_manual(values = c(seq(2.0, 0.5, by = -0.1))) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'bottom')
```

#### Kommentarer til grafen

Det denne grafen forteller oss er at hus/leiligheter som er nærme Stavanger området er overvurdert prismessig, mens hus/leiligheter som er nærme Haugesunds regionen er undervurdert

## Modell for kvart år

```{r}
pm2_n <- pm2 %>%
  group_by(aar) %>%
  select(pm2, fnr, knr, aar, aar_f, Menn_ya_p, Kvinner_ya_p, Totalt_ya_p, inc_k1, inc_k5, mf_uni_k, mf_uni_l, Trade_pc_100K) %>%
  nest()
```

-

```{r}
pm2_n
```

-

```{r}
pm2_n$data[[1]] %>%
head(n = 5)
```

-

```{r}
dim(pm2_n)
```

-

```{r}
kom_model <- function(a_df) {
  lm(pm2 ~ fnr + Totalt_ya_p + inc_k1 + inc_k5 + mf_uni_k + mf_uni_l + Trade_pc_100K, data = pm2)
}
```

-

```{r}
pm2_n <- pm2_n %>% 
  mutate(model = map(data, .f = kom_model)) 
```

-

```{r}
kom_model(pm2_n$aar) %>% 
  summary()
```

-

```{r}
pm2_n %>%
  filter(aar%in% c("2008")) %>%
  .$model %>%
  map_df(glance) %>%
  print()
```

-

```{r}
mod_sum <- pm2_n %>% 
  filter(aar %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")) %>% 
  mutate(mod_summary = map(.x = model, .f = glance)) %>% 
  unnest(mod_summary) %>% 
  print()
```

-

```{r}
coef_df <- mod_sum %>%
  map_df() %>%
  as.tibble()
```

