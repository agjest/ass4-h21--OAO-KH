---
title: "hent-ssb-data"
author:
- Kevin Ha - 571821
- Ola Andre Olofsson - 170745
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
suppressPackageStartupMessages({
library(PxWebApiData)
library(tidyverse)
library(lubridate)
})
```

```{r knr}
#Vector med relevante kommunenummer
load("knr.Rdata")
```

# Gjennomsnittleg Kvadratmeterpris

I denne oppgava skal vi studere prisen per kvadratmeter i ein utvalgt bunke av kommuner. Dataene vi skal bruke kommer ifra SSB. For at vi skal kunne gjennomføre dette må vi dermed hente dataene våres fra SSB.

## Data Henting, SSB

```{r pm2_raw}
pm2_raw <- ApiData(
  urlToData = "06035",
  Region = knr,
  ContentsCode = "KvPris",
  Boligtype = "01",
  Tid = c(as.character(2002:2017)))

# Skifter navn på variablene Region, Tid og value som angitt i oppgaven
df_pm2_raw <- data.frame(
    knr = pm2_raw[["dataset"]]$Region,
    aar = pm2_raw[["dataset"]]$Tid,
    pm2 = pm2_raw[["dataset"]]$value
    )

#  For å slippe å hanske med det uhåndterlig lange navnet på dette elementet skifter vi først navn på dette til “desc”.
names(pm2_raw)[[1]] <- "desc"
```

Boligtypen vi er interessert i er eneboliger. Ifra APIen til SSB så ser vi at denne er gitt ved "01". Vi har dermed satt våres boligtype i *pm2_raw* til å være "01" slik at vi kun får eneboliger i datasettet. På grunn av at vi vet at vi skal finne pris per kvadratmeter til eneboliger, så kan vi bruke denne forutsetningen til å fjerne *boligtype* og *ContentsCode* fra pm2_raw.

**$dataset %>% select(-Boligtype, -ContentsCode)** --> Denne skal egentlig inn i chunken ovenfor, men det lager problem med Mutate Knavn under.

## Mutate Knavn

```{r knavn}
pm2 <- pm2_raw[[1]] %>%
  mutate(knavn = pm2_raw$desc$region)
```

## Fjerning av kommune årstal. **Trenger Hjelp**

I kommunenavnene så er det oppgitt når dei ulike kommunane blei oppløyst. Vi ønsker å fjerne dette slik at vi kun for navnene på selve kommunene.

```{r}
df_pm2_raw$knavn <- str_remove(
  string = arblos_aldersgrp$knavn,
  pattern = fixed(" (-2019)"))
```
```{r}
n <- str_remove(
  string = pm2_raw$knavn, pattern = fixed("(1994-2019)"))
```


```{r Kommunenavn}
load("test_string_tib.Rdata")
# Legger inn regex mønster

moenster <- '.fixed("(1994-2019)")'

test_string_tib %>%
mutate(
knavn = str_replace(knavn, moenster, "fixed("(1994-2019),")")
)
```

## NA-Verdier - **Funka, så funka da ikkje. Gud bedre hjelpes. "Value" funke fortsatt**

Vi sjekker videre hvor mange NA-verdier vi har i datasettet *pm2*.

```{r NA_Desc}
pm2_raw %>% 
  filter(is.na(desc))
```

```{r NA_Tid}
pm2_raw %>% 
  filter(is.na(Tid))
```

```{r NA_Value}
pm2 %>% 
  filter(is.na(value))
```

Vi ser ut fra de tre kode chunkene *NA_Desc*, *NA_Tid* og *NA_Value*, at den eneste rekken som har NA-Verdier er *value* rekken.  Her har vi 2 903 NA-observasjoner.

## Complete Cases -- **Fekk Complete.Cases te å fungera, men må finna ut korleis me får frå 2006/2008, i stadenfor 2002**

Complete Cases, antal rekker uten NA verdier, fom. 2006 tom. 2017:

```{r}
complete.cases(df_pm2_raw)
```

```{r}
complete.data_06_17 <- df_pm2_raw[complete.cases(df_pm2_raw), ]
```

Complete Cases, antal rekker uten NA verdier, fom. 2008 tom. 2017:

```{r}
complete.cases(df_pm2_raw)
```

```{r}
complete.data_08_17 <- df_pm2_raw[complete.cases(df_pm2_raw), ]
```

# Andel i arbeidsfør alder

## Data Henting, SSB

```{r}
pop_08_17_ya_raw <- ApiData(
  urlToData = "07459",
  Region = knr,
  Kjonn = c(1, 2),
  Alder = list("agg:TredeltGrupperingB2",
                 c("F20-64")),
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode)
```

# Øvre og Nedre Desil/Kvintil

## Data Henting, SSB **Detta e før skatt. Ikkje oppgitt om me ska ha før eller etter skatt.** ------ **Work In Progress**

```{r}
Kvintiler_08_17 <- ApiData(
  urlToData = "12558",
  Region = knr,
  Desiler = c(1*2, 9*10),
  ContentsCode = "VerdiDesil",
  InntektSkatt = "00",
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode, -InntektSkatt)
```

# Utdanning

## Data Henting, SSB. Både menn og Kvinner, Kort og Lang høgskoleutdanning. **Må finne ut korleis vi lager variabelen "uni_p"** -------- **Work In Progress**

```{r}
Utdanning_08_17 <- ApiData(
  urlToData = "09429",
  Region = knr,
  Nivaa = c("03a", "04a"),
  Kjonn = c(1, 2),
  ContentsCode = "Personer",
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode, -value)
```





