---
title: "hent-ssb-data"
author:
- Kevin Ha - 571821
- Ola Andre Olofsson - 170745
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
suppressPackageStartupMessages({
library(PxWebApiData)
library(tidyverse)
library(lubridate)
})
```

```{r knr}
#Vector med relevante kommunenummer
load("knr.Rdata")
```

# Gjennomsnittleg Kvadratmeterpris

I denne oppgava skal vi studere prisen per kvadratmeter i ein utvalgt bunke av kommuner. Dataene vi skal bruke kommer ifra SSB. For at vi skal kunne gjennomføre dette må vi dermed hente dataene våres fra SSB.

## Data Henting, SSB

```{r pm2_raw}
pm2_raw <- ApiData(
  urlToData = "06035",
  Region = knr,
  ContentsCode = "KvPris",
  Boligtype = "01",
  Tid = c(as.character(2002:2017)))
```

-

```{r data_og_navn}
pm2 <- pm2_raw$dataset %>% 
  tibble() %>% 
  select(-Boligtype, -ContentsCode) %>% 
  rename(
    knr = Region,
    aar = Tid,
    pm2 = value
  )
head(pm2)
```

```{r Names}
names(pm2_raw)[[1]] <- "desc"
```

-

```{r Mutate}
pm2 <- pm2 %>% 
  mutate(knavn = pm2_raw$desc$region) %>% 
  group_by(knr) %>% 
  select(knr, aar, pm2, knavn)
```

Boligtypen vi er interessert i er eneboliger. Ifra APIen til SSB så ser vi at denne er gitt ved "01". Vi har dermed satt våres boligtype i *pm2_raw* til å være "01" slik at vi kun får eneboliger i datasettet. På grunn av at vi vet at vi skal finne pris per kvadratmeter til eneboliger, så kan vi bruke denne forutsetningen til å fjerne *boligtype* og *ContentsCode* fra pm2_raw.

## Fjerning av kommune årstal.

I kommunenavnene så er det oppgitt når dei ulike kommunane blei oppløyst. Vi ønsker å fjerne dette slik at vi kun for navnene på selve kommunene.

# Mønster

```{r Load_String}
load("test_string_tib.Rdata")
```

-

```{r Moenster}
#Legger inn regex mønster
moenster <- '\\s+\\(\\d*[19-]\\d*[2019]\\)\\s*$'
```

-

```{r Muterer_Moenster}
pm2 <- pm2 %>% 
  mutate(
    knavn = str_replace(knavn, moenster, ""))
```

## NA-Verdier

Vi sjekker videre hvor mange NA-verdier vi har i datasettet *pm2*.

```{r NA_Verdier}
pm2 %>% 
  map_df(is.na) %>% 
  map_df(sum) %>% 
  as.tibble()
```



Vi ser ut fra de tre kode chunkene *NA_Desc*, *NA_Tid* og *NA_Value*, at den eneste rekken som har NA-Verdier er *value* rekken.  Her har vi 2 903 NA-observasjoner.

## Complete Cases

Complete Cases, antal rekker uten NA verdier, fom. 2006 tom. 2017:

```{r Complete_Cases_2006_1}
pm2_2006 <- pm2 %>%
  filter(aar >= 2006) %>% 
  pivot_wider(
    names_from = aar,
    values_from = pm2)
```

-

```{rComplete_Cases_2006_2}
pm2_2006 %>% 
  complete.cases() %>% 
  sum()
```

Complete Cases, antal rekker uten NA verdier, fom. 2008 tom. 2017:

```{r Complete_Cases_2008_1}
pm2_2008 <- pm2 %>%
  filter(aar >= 2008) %>% 
  pivot_wider(
    names_from = aar,
    values_from = pm2)
```

-

```{r Complete_Cases_2008_2}
pm2_2008 %>% 
  complete.cases() %>% 
  sum()
```

### Konkluderer datainnsamling for gjennomsnittspris.

```{r Cleaning_House}
# Skifter navn til knr for listen av kommune nummer vi skal bruke
# i analysen
knr <- knr_c.c
# Time to clean up
rm(knr_c.c, pm2_raw)
```

# Andel i arbeidsfør alder

## Data Henting, SSB

```{r}
pop_08_17_ya_raw <- ApiData(
  urlToData = "07459",
  Region = knr,
  Kjonn = c(1, 2),
  Alder = list("agg:TredeltGrupperingB2",
                 c("F20-64")),
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode)
```

# Øvre og Nedre Desil/Kvintil

## Data Henting, SSB **Detta e før skatt. Ikkje oppgitt om me ska ha før eller etter skatt.** ------ **Work In Progress**

```{r}
Kvintiler_08_17 <- ApiData(
  urlToData = "12558",
  Region = knr,
  Desiler = c(1*2, 9*10),
  ContentsCode = "VerdiDesil",
  InntektSkatt = "00",
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode, -InntektSkatt)
```

# Utdanning

## Data Henting, SSB. Både menn og Kvinner, Kort og Lang høgskoleutdanning. **Må finne ut korleis vi lager variabelen "uni_p"** -------- **Work In Progress**

```{r}
Utdanning_08_17 <- ApiData(
  urlToData = "09429",
  Region = knr,
  Nivaa = c("03a", "04a"),
  Kjonn = c(1, 2),
  ContentsCode = "Personer",
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode, -value)
```

# Handelsomsetning

## Data Henting, SSB.

```{r}
trade_08_17 <- ApiData(
  urlToData = "07446",
  Region = knr,
  ContentsCode = "Value",
  Tid = c(as.character(2008:2017)))
```




