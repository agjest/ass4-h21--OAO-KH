---
title: "hent-ssb-data"
author:
- Kevin Ha - 571821
- Ola Andre Olofsson - 170745
fontsize: 12pt
linestrech: 1.5
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
lang: no-NB
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
suppressPackageStartupMessages({
library(PxWebApiData)
library(tidyverse)
library(lubridate)
})
```

```{r knr}
# Vector med relevante kommunenummer
load("knr.Rdata")
```

# Gjennomsnittlig kvadratmeterpris

I denne oppgaven skal vi studere prisen per kvadratmeter i et bestemt utvalg av kommuner. Oppgaven baserer seg på data som stammer fra, og er produsert av SSB. Følgelig henter vi ut dataene derfra.

## Datauthenting, SSB

```{r pm2_raw}
pm2_raw <- ApiData(
  urlToData = "06035",
  Region = knr,
  ContentsCode = "KvPris",
  Boligtype = "01",
  Tid = c(
    as.character(2002:2017)
          )
  )
```

-

```{r data_og_navn}
pm2 <- pm2_raw$dataset %>% 
  tibble() %>% 
  select(-Boligtype, -ContentsCode) %>% 
  rename(
    knr = Region,
    aar = Tid,
    pm2 = value)
```

-

```{r Velger Variabler}
pm2 <- pm2 %>% 
select(knr, aar, pm2)
```

-

```{r Head}
head(pm2)
```


```{r Names}
names(pm2_raw)[[1]] <- "desc"
```

-

```{r Mutate}
pm2 <- pm2 %>% 
  mutate(knavn = pm2_raw$desc$region) %>% 
# vent med gruppering
#  group_by(knr) %>% 
  select(knr, aar, pm2, knavn)
```

Boligtypen vi er interessert i er eneboliger. Ifra APIen til SSB så ser vi at denne er gitt ved "01". Vi har dermed satt våres boligtype i *pm2_raw* til å være "01" slik at vi kun får eneboliger i datasettet. Ettersom vi vet at vi skal finne pris per kvadratmeter til eneboliger, så kan vi bruke denne forutsetningen til å fjerne *boligtype* og *ContentsCode* fra pm2_raw.

## Fjerning av kommune årstall.

I kommunenavnene er det oppgitt når de ulike kommunene ble oppløst. Vi ønsker å fjerne dette slik at vi kun får navnene på selve kommunene.

# Mønster

```{r Load_String}
load("test_string_tib.Rdata")
```

-

```{r Moenster}
# Legger inn regex mønster
moenster <- '\\s*\\([\\d\\s-]*\\d*\\)\\s*$'
```

-

```{r Muterer_Moenster}
pm2 <- pm2 %>% 
  mutate(
    knavn = str_replace(knavn, moenster, ""))
```

## NA-Verdier

Vi sjekker videre hvor mange NA-verdier vi har i datasettet *pm2*.

```{r NA_Verdier}
pm2 %>% 
  map_df(is.na) %>% 
  map_df(sum) %>% 
  as.tibble()
```

Vi ser ut fra chunken *NA_Verdier* at vi har 2 903 NA-observasjoner på pm2-rekken.

## Complete Cases

Complete Cases, antall rekker uten NA verdier, fom. 2006 tom. 2017:

```{r Complete_Cases_2006_1}
pm2_2006 <- pm2 %>%
  filter(aar >= 2006) %>% 
  pivot_wider(
    names_from = aar,
    values_from = pm2)
```

-

```{r Complete_Cases_2006_2}
pm2_2006 %>% 
  complete.cases() %>% 
  sum()
```

Complete Cases, antall rekker uten NA-verdier, f.o.m. 2008 t.o.m. 2017:

```{r Complete_Cases_2008_1}
pm2_2008 <- pm2 %>%
  filter(aar >= 2008) %>% 
  pivot_wider(
    names_from = aar,
    values_from = pm2)
```

-

```{r Complete_Cases_2008_2}
pm2_2008 %>% 
  complete.cases() %>% 
  sum()
```

```{r Removing_NA}
pm2 <- pm2_2008 %>% 
  na.omit(pm2)
```


### Konkluderer datainnsamling for gjennomsnittspris.

Vi trenger ikke lengre pm2_raw og fjerner denne.

```{r Cleaning_House_Unos}
rm(pm2_raw, test_string_tib)
```

# Andel i arbeidsfør alder

## Datauthenting, SSB

```{r YA_Pop}
pop_08_17_ya_raw <- ApiData(
  urlToData = "07459",
  Region = knr,
  Kjonn = c(1, 2),
  Alder = list("agg:TredeltGrupperingB2",
                 c("F20-64")),
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode, -Alder)
```

-

```{r Pivot_Wider_Pop}
pop_08_17_ya <- pop_08_17_ya_raw %>%
  pivot_wider(
    # Med var navnene dere bruker
    id_cols = c(Region, Tid),
    names_from = Kjonn,
    # names prefix er ofte grei å bruke for å få variabelnavn R liker
    names_prefix = "sex",
    values_from = value)
# så kan dere regne ut totalt = sex1 + sex2 etc
```

-

```{r Names}
names(pop_08_17_ya)[[1]] <- "knr"
names(pop_08_17_ya)[[2]] <- "aar"
names(pop_08_17_ya)[[3]] <- "ya_menn"
names(pop_08_17_ya)[[4]] <- "ya_kvinner"
```

-

```{r Ya_Total}
pop_08_17_ya <- pop_08_17_ya %>% 
  mutate(ya_Total = ya_menn+ya_kvinner)
```

-

```{r Dim}
dim(pop_08_17_ya)
```

## Datauthenting 2, SSB

```{r Total_Pop}
pop_08_17_raw <- ApiData(
  urlToData = "07459",
  Region = knr,
  Kjonn = c(1, 2),
  Alder = list("agg:TodeltGrupperingB",
                 c("H17", "H18")),
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode)
```

-

```{r Datasett}
pop_08_17 <- pop_08_17_raw %>%
  pivot_wider(
    names_from = Kjonn,
    values_from = value)
```

-

```{r Names}
names(pop_08_17)[[1]] <- "knr"
names(pop_08_17)[[2]] <- "Alder"
names(pop_08_17)[[3]] <- "aar"
names(pop_08_17)[[4]] <- "Menn"
names(pop_08_17)[[5]] <- "Kvinner"
```

-

```{r Pivot_Wider_2}
pop_08_17 <- pop_08_17 %>% 
  pivot_wider(
    names_from = Alder,
    values_from = c(Menn, Kvinner))
```

-

```{r mutating_variables}
pop_08_17 <- pop_08_17 %>% 
  mutate(Menn_t = Menn_H17 + Menn_H18) %>% 
  mutate(Kvinner_t = Kvinner_H17 + Kvinner_H18) %>% 
  mutate(Totalt_t = Menn_t + Kvinner_t)
```

-

```{r Velger_Variabler}
pop_08_17 <- pop_08_17 %>%
  select(knr, aar, Menn_t, Kvinner_t, Totalt_t)
```

-

## Sammenslåing

```{r Sammenslåing_av_Datasett}
pop_08_17_ya_p <- merge(pop_08_17, pop_08_17_ya)
```

### Muterer nye variabler prosentvis yrkesaktiv alder

```{r Muterer_Variabler}
pop_08_17_ya_p <- pop_08_17_ya_p %>% 
  mutate(Menn_ya_p = ya_menn/Menn_t*100) %>% 
  mutate(Kvinner_ya_p = ya_kvinner/Kvinner_t*100) %>% 
  mutate(Totalt_ya_p = ya_Total/Totalt_t*100)
```

-

```{r Velger_Variabler}
pop_08_17_ya_p <- pop_08_17_ya_p %>% 
  select(knr, aar, Menn_ya_p, Kvinner_ya_p, Totalt_ya_p)
```

Sjekker om vi har gjort rett

```{r Head}
head(pop_08_17_ya_p)
```

Legger til *ya* variablene frå datasettet **pop_08_17_ya_p** inn i datasettet **pm2**.

```{r Merger_Pm2_og_Ya}
pm2 <- merge(pm2, pop_08_17_ya)
```

## Rydder opp rot

```{r Cleaning_House_Dos}
rm(pop_08_17_raw, pop_08_17_ya_raw, pm2_2006, pm2_2008, pop_08_17, pop_08_17_ya)
```

# Øvre og Nedre Desil/Kvintil

## Datauthenting, SSB

```{r Henter_Data}
kvintiler_08_17_raw <- ApiData(
  urlToData = "12558",
  Region = knr,
  #Krever tekststrenger
  #  Desiler = c(1, 2, 9, 10),
  Desiler = c("01", "02", "09", "10"),
  #  ContentsCode = "VerdiDesil",
  ContentsCode = "AndelHush",
  InntektSkatt = "00",
  Tid = c(
    as.character(2008:2017)
          )
  )$dataset %>% 
  select(Region, Desiler, Tid, value)
```

-

```{r Pivot_Wider}
#Nu går alt så meget bedre ;-)
kvintiler_08_17 <- kvintiler_08_17_raw %>%
  pivot_wider(
    names_from = Desiler,
    values_from = value)
```

-

```{r Navngjer_Variabler}
names(kvintiler_08_17)[[1]] <- "knr"
names(kvintiler_08_17)[[2]] <- "aar"
names(kvintiler_08_17)[[3]] <- "Desil_1"
names(kvintiler_08_17)[[4]] <- "Desil_2"
names(kvintiler_08_17)[[5]] <- "Desil_9"
names(kvintiler_08_17)[[6]] <- "Desil_10"
```

-

```{r Muterer_Variabler}
kvintiler_08_17 <- kvintiler_08_17 %>% 
  mutate(inc_k1 = Desil_1 + Desil_2) %>% 
  mutate(inc_k5 = Desil_9 + Desil_10)
```

-

```{r Velger_Variabler}
kvintiler_08_17 <- kvintiler_08_17 %>%
  select(knr, aar, inc_k1, inc_k5)
```

-

```{r Merger_Datasett}
pm2 <- merge(pm2, kvintiler_08_17)
```

-

Rydder opp rot, atter en gang

```{r Cleaning_House_Tres}
rm(kvintiler_08_17, kvintiler_08_17_raw, pop_08_17_ya_p)
```


# Utdanning

## Datauthenting, SSB. Både menn og Kvinner, Kort og Lang høyskoleutdanning. **Må finne ut korleis vi lager variabelen "uni_p"** -------- **Work In Progress**

```{r}
Utdanning_08_17 <- ApiData(
  urlToData = "09429",
  Region = knr,
  Nivaa = c("03a", "04a"),
  Kjonn = c(1, 2),
  ContentsCode = "Personer",
  Tid = c(as.character(2008:2017))
)$dataset %>% 
  select(-ContentsCode)
```

-

```{r}
utdanning_08_17 <- utdanning_08_17_raw %>% 
  pivot_wider(
    names_from = "Nivaa",
    values_from = value)
```

-

```{r Navn}
names(utdanning_08_17)[[1]] <- "knr"
names(utdanning_08_17)[[2]] <- "Kjonn"
names(utdanning_08_17)[[3]] <- "aar"
names(utdanning_08_17)[[5]] <- "Utd_Kort"
names(utdanning_08_17)[[6]] <- "Utd_Lang"
```

-

```{r}
utdanning_08_17 <- utdanning_08_17 %>% 
  pivot_wider(
    names_from = knr,
    values_from = Kjonn)
```

-

```{r}
utdanning_08_17 <- utdanning_08_17 %>% 
rename(Universitets- og høgskolenviå, kort = '03a',
       Universitets- og høgskolenviå, lang = '04a')
```

# Handelsomsetning per innbygger

## Datauthenting, SSB.
**Hvordan lager vi variabelen "Trade_pc"**
```{r}
trade_08_17 <- ApiData(
  urlToData = "04776",
  Region = knr,
  ContentsCode = "Value",
  Tid = c(as.character(2008:2017))
  )$dataset %>% 
  select()

# Kall variabelen for "Trade_pc"
```


